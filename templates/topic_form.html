<!-- templates/topic_form.html -->
{% extends "base.html" %}

{% if mode == "create" %}
  {% set page_title = "Create Topic" %}
{% else %}
  {% set page_title = "Edit Topic" %}
{% endif %}

{% block title %}{{ page_title }} â€¢ Knowledge App{% endblock %}

{% block content %}
<div class="form-card">
  <h2 class="form-title">{{ page_title }}</h2>

  <form method="post" class="form" enctype="multipart/form-data">
    <div class="form-group">
      <label for="title" class="field-label">Title</label>
      <input
        id="title"
        name="title"
        type="text"
        class="input"
        required
        value="{{ (topic.title if topic else '') | e }}"
      />
    </div>

    <div class="form-group">
      <label for="body" class="field-label">Body</label>
            <!-- Hidden field Flask will actually receive -->
        <input type="hidden" name="body" id="body-input">

        <!-- Visible Quill editor -->
        <div id="quill-editor" style="height: 300px;">
        {{ (topic.body if topic else '')|safe }}
        </div>
    </div>

    <div class="form-group">
        <label class="field-label">Upload Images</label>
        <input type="file" name="images" multiple accept="image/*" class="input" id="image-upload">
        <div id="image-titles-container"></div>
    </div>

    {% if mode == "edit" and topic.images %}
        <div class="image-editor-list">
            {% for img in topic.images %}
            <div class="img-edit-card">
                <img src="{{ url_for('static', filename='uploads/' ~ img.filename) }}"
                    class="img-thumb">

                <input type="text"
                    name="image_title_{{ img.id }}"
                    value="{{ (img.title if img.title else '') | e }}"
                    class="input img-title-input"
                    placeholder="Image title">

                <label class="img-delete">
                <input type="checkbox" name="delete_image_{{ img.id }}">
                Delete
                </label>
            </div>
            {% endfor %}
        </div>
        {% endif %}


    <div class="form-actions">
      <button type="submit" class="btn primary">
        {% if mode == "create" %}Create{% else %}Save changes{% endif %}
      </button>
      <a href="{{ url_for('index') }}" class="btn ghost">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
  <!-- Quill JS + CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
    // Capture existing HTML BEFORE initializing Quill
    const editorElement = document.getElementById('quill-editor');
    const existingHTML = editorElement.innerHTML.trim();
    
    var quill = new Quill('#quill-editor', {
      theme: 'snow',
      placeholder: 'Write something...',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          ['blockquote', 'code-block'],
          [{ 'list': 'ordered' }, { 'list': 'bullet' }],
          [{ 'indent': '-1' }, { 'indent': '+1' }],
          ['link'],
          ['clean']
        ]
      }
    });

    // Prefill Quill with existing content after initialization
    if (existingHTML) {
      quill.root.innerHTML = existingHTML;
    }

    // Before submit, put Quill HTML into hidden input
    document.querySelector("form").addEventListener("submit", function () {
      document.getElementById("body-input").value = quill.root.innerHTML;
    });

    // Handle image upload with titles
    const imageUpload = document.getElementById("image-upload");
    const imageTitlesContainer = document.getElementById("image-titles-container");
    
    if (imageUpload && imageTitlesContainer) {
      imageUpload.addEventListener("change", function(e) {
        imageTitlesContainer.innerHTML = "";
        const files = Array.from(e.target.files);
        
        files.forEach((file, index) => {
          const div = document.createElement("div");
          div.className = "image-upload-item";
          div.style.marginTop = "8px";
          div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 14px; color: #666;">${file.name}</span>
              <input 
                type="text" 
                name="image_title_new_${index}" 
                class="input" 
                style="flex: 1; max-width: 300px;"
                placeholder="Image title (optional)">
            </div>
          `;
          imageTitlesContainer.appendChild(div);
        });
      });
    }
  </script>
{% endblock %}